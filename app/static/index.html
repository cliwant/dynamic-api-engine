<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt API Engine - API Tester</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-purple: #a371f7;
            --accent-orange: #d29922;
            --accent-red: #f85149;
            --accent-cyan: #39c5cf;
            --accent-pink: #db61a2;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .container { display: grid; grid-template-columns: 300px 1fr; height: 100vh; }
        
        /* Sidebar */
        .sidebar { background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border-color); }
        .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .logo-text { font-size: 16px; font-weight: 700; }
        .logo-text span { color: var(--accent-blue); }
        
        .search-box { position: relative; margin-bottom: 10px; }
        .search-box input { width: 100%; padding: 9px 12px 9px 32px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px; outline: none; }
        .search-box input:focus { border-color: var(--accent-blue); }
        .search-box::before { content: "ğŸ”"; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; }
        
        .sidebar-buttons { display: flex; gap: 6px; flex-wrap: wrap; }
        .sidebar-btn { flex: 1; min-width: 80px; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 8px 6px; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: transform 0.15s; }
        .sidebar-btn:hover { transform: translateY(-1px); }
        .sidebar-btn.refresh { background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); }
        .sidebar-btn.add { background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan)); color: white; }
        .sidebar-btn.llm { background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); color: white; }
        
        .api-list { flex: 1; overflow-y: auto; padding: 10px; }
        .api-group { margin-bottom: 14px; }
        .api-group-header { font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; padding: 6px 10px; }
        .api-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
        .api-item:hover { background: var(--bg-tertiary); }
        .api-item.active { background: var(--bg-tertiary); border: 1px solid var(--accent-blue); }
        .method-badge { font-family: 'JetBrains Mono', monospace; font-size: 9px; font-weight: 600; padding: 2px 5px; border-radius: 3px; min-width: 36px; text-align: center; }
        .method-badge.get { background: rgba(59, 185, 80, 0.2); color: var(--accent-green); }
        .method-badge.post { background: rgba(88, 166, 255, 0.2); color: var(--accent-blue); }
        .api-item-info { flex: 1; min-width: 0; }
        .api-item-path { font-family: 'JetBrains Mono', monospace; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .api-item-name { font-size: 10px; color: var(--text-secondary); margin-top: 1px; }
        
        /* Main */
        .main { display: flex; flex-direction: column; overflow: hidden; }
        .main-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .api-title { display: flex; align-items: center; gap: 10px; }
        .api-title h1 { font-size: 18px; font-weight: 600; }
        .type-badge { font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 3px 7px; border-radius: 4px; background: rgba(163, 113, 247, 0.2); color: var(--accent-purple); }
        .immutable-badge { font-size: 9px; padding: 3px 7px; border-radius: 4px; background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        
        .send-btn { display: flex; align-items: center; gap: 6px; padding: 9px 18px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border: none; border-radius: 6px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; }
        .send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3); }
        
        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); padding: 0 20px; overflow-x: auto; }
        .tab { padding: 10px 14px; font-size: 12px; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        
        .main-content { flex: 1; overflow: hidden; }
        .tab-panel { display: none; height: 100%; overflow: auto; }
        .tab-panel.active { display: block; }
        
        /* Request Panel */
        .request-panel { display: grid; grid-template-rows: auto 1fr; height: 100%; }
        .request-section { padding: 16px 20px; border-bottom: 1px solid var(--border-color); }
        .section-title { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        
        .url-bar { display: flex; gap: 10px; margin-bottom: 14px; }
        .url-input { flex: 1; display: flex; align-items: center; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; }
        .url-base { padding: 8px 10px; background: var(--bg-secondary); color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; font-size: 12px; border-right: 1px solid var(--border-color); }
        .url-input input { flex: 1; padding: 8px 10px; background: transparent; border: none; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 12px; outline: none; }
        
        .params-grid { display: grid; gap: 6px; }
        .param-row { display: grid; grid-template-columns: 120px 1fr 60px auto; gap: 6px; align-items: center; }
        .param-row input, .param-row select { padding: 7px 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-primary); font-size: 12px; outline: none; }
        .param-row input:focus { border-color: var(--accent-blue); }
        .param-required { color: var(--accent-red); font-size: 9px; }
        .fill-sample-btn { padding: 4px 8px; background: var(--accent-cyan); color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; }
        
        /* Response */
        .response-section { display: flex; flex-direction: column; overflow: hidden; padding: 16px 20px; height: 100%; }
        .response-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .response-status { display: flex; align-items: center; gap: 10px; }
        .status-badge { padding: 3px 8px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; }
        .status-badge.success { background: rgba(59, 185, 80, 0.2); color: var(--accent-green); }
        .status-badge.error { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .response-time { font-size: 11px; color: var(--text-secondary); }
        
        .view-toggle { display: flex; gap: 4px; }
        .view-toggle button { padding: 4px 10px; font-size: 11px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-secondary); cursor: pointer; border-radius: 4px; }
        .view-toggle button.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        
        .response-body { flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; overflow: auto; padding: 14px; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.5; }
        .response-body pre { margin: 0; white-space: pre-wrap; word-break: break-word; }
        .json-key { color: var(--accent-cyan); }
        .json-string { color: var(--accent-green); }
        .json-number { color: var(--accent-orange); }
        .json-boolean { color: var(--accent-purple); }
        .json-null { color: var(--text-secondary); }
        
        /* Table View */
        .table-view { width: 100%; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 16px; }
        .data-table th { background: var(--bg-secondary); padding: 8px 10px; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; }
        .data-table td { padding: 6px 10px; border-bottom: 1px solid var(--border-color); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .data-table tr:hover td { background: rgba(88, 166, 255, 0.05); }
        .table-title { font-size: 12px; font-weight: 600; color: var(--accent-cyan); margin-bottom: 8px; }
        
        /* Forms */
        .form-panel { padding: 20px; max-width: 900px; }
        .form-section { margin-bottom: 20px; }
        .form-section-title { font-size: 13px; font-weight: 600; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
        .form-row.full { grid-template-columns: 1fr; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-label { font-size: 11px; font-weight: 500; color: var(--text-secondary); }
        .form-label .required { color: var(--accent-red); }
        .form-input, .form-select, .form-textarea { padding: 9px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px; outline: none; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent-blue); }
        .form-textarea { font-family: 'JetBrains Mono', monospace; min-height: 90px; resize: vertical; }
        .form-hint { font-size: 10px; color: var(--text-secondary); }
        
        .test-section { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 14px; margin-bottom: 14px; }
        .test-section.success { border-color: var(--accent-green); }
        .test-section.error { border-color: var(--accent-red); }
        .test-btn { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--accent-orange); border: none; border-radius: 6px; color: white; font-size: 12px; font-weight: 600; cursor: pointer; }
        .test-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .test-result { margin-top: 12px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 11px; max-height: 200px; overflow: auto; }
        
        .submit-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan)); border: none; border-radius: 6px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; }
        .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 185, 80, 0.3); }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* Metadata */
        .metadata-panel { padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; align-content: start; }
        .metadata-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
        .metadata-card-header { padding: 14px 16px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px; }
        .metadata-card-header h3 { font-size: 13px; font-weight: 600; }
        .table-badge { font-family: 'JetBrains Mono', monospace; font-size: 9px; padding: 2px 6px; border-radius: 3px; background: rgba(57, 197, 207, 0.2); color: var(--accent-cyan); }
        .metadata-card-body { padding: 14px 16px; max-height: 300px; overflow: auto; }
        .info-grid { display: grid; gap: 8px; }
        .info-row { display: grid; grid-template-columns: 110px 1fr; gap: 10px; font-size: 12px; }
        .info-label { color: var(--text-secondary); font-weight: 500; }
        .info-value { color: var(--text-primary); font-family: 'JetBrains Mono', monospace; word-break: break-all; }
        .info-value.code { background: var(--bg-tertiary); padding: 6px 10px; border-radius: 5px; white-space: pre-wrap; max-height: 120px; overflow: auto; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 500; }
        .badge.green { background: rgba(59, 185, 80, 0.2); color: var(--accent-green); }
        .badge.red { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .badge.blue { background: rgba(88, 166, 255, 0.2); color: var(--accent-blue); }
        .badge.purple { background: rgba(163, 113, 247, 0.2); color: var(--accent-purple); }
        
        /* LLM Panel */
        .llm-panel { padding: 20px; max-width: 1000px; }
        .table-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-bottom: 16px; max-height: 200px; overflow-y: auto; }
        .table-item { padding: 10px; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.15s; }
        .table-item:hover { border-color: var(--accent-blue); }
        .table-item.selected { border-color: var(--accent-green); background: rgba(59, 185, 80, 0.1); }
        .table-item-name { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; }
        .table-item-info { font-size: 10px; color: var(--text-secondary); margin-top: 2px; }
        
        .schema-preview { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; padding: 14px; margin-bottom: 16px; max-height: 280px; overflow: auto; }
        .schema-table { margin-bottom: 14px; }
        .schema-table-name { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; color: var(--accent-cyan); margin-bottom: 6px; }
        .schema-columns { display: grid; gap: 2px; font-size: 11px; }
        .schema-column { display: grid; grid-template-columns: 140px 100px 1fr; gap: 6px; padding: 3px 0; border-bottom: 1px solid var(--border-color); }
        .schema-column-name { font-family: 'JetBrains Mono', monospace; }
        .schema-column-type { color: var(--text-secondary); }
        .schema-column-sample { color: var(--accent-orange); font-family: 'JetBrains Mono', monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .llm-config { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px; padding: 14px; background: var(--bg-secondary); border-radius: 8px; }
        .llm-config .form-group { margin: 0; }
        
        .auth-section { padding: 14px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px; }
        .auth-section-title { font-size: 12px; font-weight: 600; margin-bottom: 10px; }
        
        .generated-result { background: var(--bg-secondary); border: 1px solid var(--accent-green); border-radius: 10px; padding: 16px; margin-top: 16px; }
        .generated-result h4 { font-size: 13px; margin-bottom: 14px; color: var(--accent-green); }
        .generated-field { margin-bottom: 10px; }
        .generated-field-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 3px; }
        .generated-field-value { font-family: 'JetBrains Mono', monospace; font-size: 12px; padding: 6px 10px; background: var(--bg-tertiary); border-radius: 5px; max-height: 120px; overflow: auto; white-space: pre-wrap; }
        
        /* Audit */
        .audit-list { display: grid; gap: 10px; }
        .audit-item { padding: 10px 14px; background: var(--bg-tertiary); border-radius: 6px; border-left: 3px solid var(--accent-blue); }
        .audit-item.CREATE, .audit-item.VERSION_CREATE { border-left-color: var(--accent-green); }
        .audit-item.ACTIVATE, .audit-item.SET_CURRENT { border-left-color: var(--accent-green); }
        .audit-item.DEACTIVATE { border-left-color: var(--accent-orange); }
        .audit-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
        .audit-action { font-weight: 600; font-size: 12px; }
        .audit-time { font-size: 10px; color: var(--text-secondary); }
        .audit-details { font-size: 11px; color: var(--text-secondary); }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; width: 90%; max-width: 700px; max-height: 90vh; overflow: auto; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .modal-header h2 { font-size: 16px; font-weight: 600; }
        .modal-close { width: 28px; height: 28px; border: none; background: transparent; color: var(--text-secondary); font-size: 18px; cursor: pointer; border-radius: 5px; }
        .modal-close:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .modal-body { padding: 20px; }
        
        .alert { padding: 10px 14px; border-radius: 6px; margin-bottom: 14px; font-size: 12px; }
        .alert.info { background: rgba(88, 166, 255, 0.1); border: 1px solid var(--accent-blue); color: var(--accent-blue); }
        .alert.success { background: rgba(59, 185, 80, 0.1); border: 1px solid var(--accent-green); color: var(--accent-green); }
        .alert.warning { background: rgba(210, 153, 34, 0.1); border: 1px solid var(--accent-orange); color: var(--accent-orange); }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); padding: 30px; }
        .empty-state-icon { font-size: 40px; margin-bottom: 12px; }
        .empty-state-text { font-size: 13px; }
        
        .loading { display: flex; align-items: center; justify-content: center; height: 100%; }
        .spinner { width: 28px; height: 28px; border: 3px solid var(--border-color); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 7px; height: 7px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">âš¡</div>
                    <div class="logo-text">Prompt <span>API</span></div>
                </div>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="API ê²€ìƒ‰...">
                </div>
                <div class="sidebar-buttons">
                    <button class="sidebar-btn refresh" onclick="loadApis()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
                    <button class="sidebar-btn add" onclick="openAddModal()">â• ì¶”ê°€</button>
                    <button class="sidebar-btn llm" onclick="switchTab('llm')">ğŸ¤– LLM</button>
                </div>
                <div class="sidebar-buttons" style="margin-top: 6px;">
                    <button class="sidebar-btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color);" onclick="switchTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
                    <button class="sidebar-btn" style="background: var(--accent-orange); color: white;" onclick="exportApis()">ğŸ“¥ Export</button>
                </div>
            </div>
            <div class="api-list" id="apiList"></div>
        </div>
        
        <div class="main">
            <div class="main-header">
                <div class="api-title">
                    <h1 id="apiTitle">APIë¥¼ ì„ íƒí•˜ì„¸ìš”</h1>
                    <span class="type-badge" id="logicType" style="display:none;"></span>
                    <span class="immutable-badge">ğŸ”’ Immutable</span>
                </div>
                <button class="send-btn" onclick="sendRequest()">â–¶ Send</button>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="request" onclick="switchTab('request')">ğŸ“¤ Request</div>
                <div class="tab" data-tab="metadata" onclick="switchTab('metadata')">ğŸ“‹ Metadata</div>
                <div class="tab" data-tab="add-version" onclick="switchTab('add-version')">â• ë²„ì „ì¶”ê°€</div>
                <div class="tab" data-tab="llm" onclick="switchTab('llm')">ğŸ¤– LLM ìƒì„±</div>
                <div class="tab" data-tab="ai-features" onclick="switchTab('ai-features')">ğŸ§  AI ê¸°ëŠ¥</div>
                <div class="tab" data-tab="dashboard" onclick="switchTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>
            </div>
            
            <div class="main-content">
                <!-- Request Tab -->
                <div class="tab-panel active" id="tab-request">
                    <div class="request-panel">
                        <div class="request-section">
                            <div class="section-title">Request <button class="fill-sample-btn" onclick="fillSampleParams()" id="sampleBtn" style="display:none;">ìƒ˜í”Œê°’ ì±„ìš°ê¸°</button></div>
                            <div class="url-bar">
                                <div class="url-input">
                                    <span class="url-base">http://localhost:8000</span>
                                    <input type="text" id="urlPath" placeholder="/api/..." readonly>
                                </div>
                            </div>
                            <div class="section-title">Parameters</div>
                            <div class="params-grid" id="paramsGrid"></div>
                        </div>
                        <div class="response-section">
                            <div class="response-header">
                                <div class="section-title">Response</div>
                                <div class="response-status" id="responseStatus" style="display:none;">
                                    <span class="status-badge" id="statusBadge"></span>
                                    <span class="response-time" id="responseTime"></span>
                                </div>
                                <div class="view-toggle" id="viewToggle" style="display:none;">
                                    <button class="active" onclick="setViewMode('json')">JSON</button>
                                    <button onclick="setViewMode('table')">Table</button>
                                </div>
                            </div>
                            <div class="response-body" id="responseBody">
                                <div class="empty-state"><div class="empty-state-icon">ğŸ“¡</div><div class="empty-state-text">Send a request</div></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Metadata Tab -->
                <div class="tab-panel" id="tab-metadata">
                    <div class="metadata-panel" id="metadataPanel">
                        <div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><div class="empty-state-text">APIë¥¼ ì„ íƒí•˜ë©´ ë©”íƒ€ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤</div></div>
                    </div>
                </div>
                
                <!-- Add Version Tab -->
                <div class="tab-panel" id="tab-add-version">
                    <div class="form-panel">
                        <div class="alert info">ğŸ”’ <strong>Immutable:</strong> ìƒˆ ë²„ì „ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìœ¼ë©°, í…ŒìŠ¤íŠ¸ í†µê³¼ í›„ ìƒì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
                        <div id="addVersionForm"><div class="empty-state"><div class="empty-state-icon">ğŸ“¦</div><div class="empty-state-text">APIë¥¼ ì„ íƒí•˜ì„¸ìš”</div></div></div>
                    </div>
                </div>
                
                <!-- LLM Tab -->
                <div class="tab-panel" id="tab-llm">
                    <div class="llm-panel">
                        <div class="alert info">ğŸ¤– <strong>LLM API ìƒì„±:</strong> í…Œì´ë¸” ì„ íƒ â†’ ìŠ¤í‚¤ë§ˆ í™•ì¸ â†’ ì˜ë„ ì…ë ¥ â†’ AI ìƒì„± â†’ í…ŒìŠ¤íŠ¸ â†’ ì ìš©</div>
                        
                        <div class="form-section">
                            <div class="form-section-title">ğŸ“Š í…Œì´ë¸” ì„ íƒ</div>
                            <div class="table-selector" id="tableSelector"><div class="loading"><div class="spinner"></div></div></div>
                        </div>
                        
                        <div class="form-section" id="schemaPreviewSection" style="display:none;">
                            <div class="form-section-title">ğŸ“‹ ì„ íƒëœ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ (ì»¬ëŸ¼ + ìƒ˜í”Œ ë°ì´í„°)</div>
                            <div class="schema-preview" id="schemaPreview"></div>
                        </div>
                        
                        <div class="form-section">
                            <div class="form-section-title">âš™ï¸ LLM ì„¤ì •</div>
                            <div class="llm-config">
                                <div class="form-group">
                                    <label class="form-label">ëª¨ë¸</label>
                                    <select class="form-select" id="llmModel" onchange="updateAuthFields()"></select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Temperature</label>
                                    <input type="number" class="form-input" id="llmTemp" value="0.7" min="0" max="2" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Max Tokens</label>
                                    <input type="number" class="form-input" id="llmMaxTokens" value="4000" min="100" max="8000">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Top P</label>
                                    <input type="number" class="form-input" id="llmTopP" value="1.0" min="0" max="1" step="0.1">
                                </div>
                            </div>
                            
                            <div class="auth-section" id="authSection">
                                <div class="auth-section-title">ğŸ” ì¸ì¦</div>
                                <div id="authFields"></div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">HTTP ë©”ì„œë“œ</label>
                                    <select class="form-select" id="llmMethod"><option value="GET">GET</option><option value="POST">POST</option></select>
                                </div>
                            </div>
                            <div class="form-row full">
                                <div class="form-group">
                                    <label class="form-label">ì‚¬ìš©ì ì˜ë„ <span class="required">*</span></label>
                                    <textarea class="form-textarea" id="llmIntent" placeholder="ì˜ˆ: ì‚¬ìš©ì ëª©ë¡ì„ ìµœê·¼ ê°€ì…ìˆœìœ¼ë¡œ ì¡°íšŒí•˜ê³  íšŒì‚¬ ì •ë³´ë„ í•¨ê»˜ ë³´ì—¬ì£¼ì„¸ìš”"></textarea>
                                </div>
                            </div>
                            <button class="submit-btn" onclick="generateWithLLM()" id="llmGenerateBtn">ğŸ¤– API ìƒì„±</button>
                        </div>
                        
                        <div id="llmResult"></div>
                    </div>
                </div>
                
                <!-- AI Features Tab -->
                <div class="tab-panel" id="tab-ai-features">
                    <div class="form-panel" style="max-width: 1200px;">
                        <div class="alert info">ğŸ§  <strong>AI ê¸°ëŠ¥:</strong> SQL ìµœì í™” ì œì•ˆ | í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ìë™ ìƒì„± | ìì—°ì–´ API í˜¸ì¶œ</div>
                        
                        <!-- Sub-tabs for AI features -->
                        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                            <button class="sidebar-btn" style="background: var(--accent-purple); color: white;" onclick="showAiSubTab('chat')" id="aiSubTab-chat">ğŸ’¬ ìì—°ì–´ API</button>
                            <button class="sidebar-btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color);" onclick="showAiSubTab('optimize')" id="aiSubTab-optimize">ğŸ”§ SQL ìµœì í™”</button>
                            <button class="sidebar-btn" style="background: var(--bg-tertiary); border: 1px solid var(--border-color);" onclick="showAiSubTab('testcase')" id="aiSubTab-testcase">ğŸ§ª í…ŒìŠ¤íŠ¸ ìƒì„±</button>
                        </div>
                        
                        <!-- Chat Sub-panel -->
                        <div id="aiPanel-chat" class="ai-sub-panel">
                            <div class="metadata-card" style="margin-bottom: 20px;">
                                <div class="metadata-card-header">
                                    <span>ğŸ’¬</span>
                                    <h3>ìì—°ì–´ API í˜¸ì¶œ</h3>
                                </div>
                                <div class="metadata-card-body" style="max-height: none;">
                                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 14px;">
                                        ìì—°ì–´ë¡œ ì§ˆë¬¸í•˜ë©´ AIê°€ ì í•©í•œ APIë¥¼ ì°¾ì•„ ì‹¤í–‰í•©ë‹ˆë‹¤.<br>
                                        ì˜ˆ: "ìµœê·¼ ê°€ì…í•œ ì‚¬ìš©ì 10ëª… ë³´ì—¬ì¤˜", "ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ ëª©ë¡"
                                    </p>
                                    
                                    <div class="form-group" style="margin-bottom: 14px;">
                                        <label class="form-label">ì§ˆë¬¸ <span class="required">*</span></label>
                                        <textarea class="form-textarea" id="chatQuestion" placeholder="ì˜ˆ: í™ê¸¸ë™ íšŒì‚¬ ì •ë³´ ì¡°íšŒí•´ì¤˜" style="min-height: 80px;"></textarea>
                                    </div>
                                    
                                    <div class="form-row" style="margin-bottom: 14px;">
                                        <div class="form-group">
                                            <label class="form-label">ìë™ ì‹¤í–‰</label>
                                            <select class="form-select" id="chatAutoExecute">
                                                <option value="false">ë¶„ì„ë§Œ (API ì„ íƒ + íŒŒë¼ë¯¸í„° ì¶”ì¶œ)</option>
                                                <option value="true">ìë™ ì‹¤í–‰ (ì‹ ë¢°ë„ 70% ì´ìƒ)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">LLM ëª¨ë¸</label>
                                            <select class="form-select" id="chatLlmModel"></select>
                                        </div>
                                    </div>
                                    
                                    <button class="submit-btn" onclick="sendChatQuery()">ğŸ’¬ AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°</button>
                                </div>
                            </div>
                            
                            <div id="chatResult"></div>
                        </div>
                        
                        <!-- SQL Optimize Sub-panel -->
                        <div id="aiPanel-optimize" class="ai-sub-panel" style="display: none;">
                            <div class="metadata-card" style="margin-bottom: 20px;">
                                <div class="metadata-card-header">
                                    <span>ğŸ”§</span>
                                    <h3>SQL ìµœì í™” ì œì•ˆ</h3>
                                </div>
                                <div class="metadata-card-body" style="max-height: none;">
                                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 14px;">
                                        SQL ì¿¼ë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ì¸ë±ìŠ¤ í™œìš©, ì¿¼ë¦¬ ì¬ì‘ì„±, ì„±ëŠ¥ ê°œì„  ë°©ì•ˆì„ ì œì•ˆí•©ë‹ˆë‹¤.
                                    </p>
                                    
                                    <div class="form-group" style="margin-bottom: 14px;">
                                        <label class="form-label">SQL ì¿¼ë¦¬ <span class="required">*</span></label>
                                        <textarea class="form-textarea" id="optimizeSql" placeholder="SELECT * FROM APP_USER_L WHERE ..." style="min-height: 100px;"></textarea>
                                    </div>
                                    
                                    <div class="form-group" style="margin-bottom: 14px;">
                                        <label class="form-label">ê´€ë ¨ í…Œì´ë¸” ì„ íƒ</label>
                                        <div class="table-selector" id="optimizeTableSelector" style="max-height: 150px;"></div>
                                    </div>
                                    
                                    <div class="form-row" style="margin-bottom: 14px;">
                                        <div class="form-group">
                                            <label class="form-label">í˜„ì¬ ì‹¤í–‰ ì‹œê°„ (ms)</label>
                                            <input type="number" class="form-input" id="optimizeExecTime" placeholder="ì„ íƒì‚¬í•­">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">LLM ëª¨ë¸</label>
                                            <select class="form-select" id="optimizeLlmModel"></select>
                                        </div>
                                    </div>
                                    
                                    <button class="submit-btn" onclick="optimizeSqlQuery()">ğŸ”§ SQL ìµœì í™” ë¶„ì„</button>
                                </div>
                            </div>
                            
                            <div id="optimizeResult"></div>
                        </div>
                        
                        <!-- Test Case Sub-panel -->
                        <div id="aiPanel-testcase" class="ai-sub-panel" style="display: none;">
                            <div class="metadata-card" style="margin-bottom: 20px;">
                                <div class="metadata-card-header">
                                    <span>ğŸ§ª</span>
                                    <h3>í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ìë™ ìƒì„±</h3>
                                </div>
                                <div class="metadata-card-body" style="max-height: none;">
                                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 14px;">
                                        API ì •ì˜ë¥¼ ë¶„ì„í•˜ì—¬ ì •ìƒ/ì—ëŸ¬/ê²½ê³„ê°’/ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
                                    </p>
                                    
                                    <div class="form-group" style="margin-bottom: 14px;">
                                        <label class="form-label">API ì„ íƒ <span class="required">*</span></label>
                                        <select class="form-select" id="testcaseApiSelect">
                                            <option value="">APIë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                        </select>
                                    </div>
                                    
                                    <div id="testcaseApiInfo" style="display: none; margin-bottom: 14px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px;">
                                        <div class="info-row"><span class="info-label">ê²½ë¡œ</span><span class="info-value" id="testcaseApiPath"></span></div>
                                        <div class="info-row"><span class="info-label">ë¡œì§</span><span class="info-value" id="testcaseApiLogic" style="font-size: 10px;"></span></div>
                                    </div>
                                    
                                    <div class="form-group" style="margin-bottom: 14px;">
                                        <label class="form-label">LLM ëª¨ë¸</label>
                                        <select class="form-select" id="testcaseLlmModel"></select>
                                    </div>
                                    
                                    <button class="submit-btn" onclick="generateTestCases()">ğŸ§ª í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ìƒì„±</button>
                                </div>
                            </div>
                            
                            <div id="testcaseResult"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard Tab -->
                <div class="tab-panel" id="tab-dashboard">
                    <div class="form-panel" style="max-width: 1200px;">
                        <div class="alert info">ğŸ“Š <strong>ëŒ€ì‹œë³´ë“œ:</strong> API í†µê³„ ë° ì‚¬ìš©ëŸ‰ ë¶„ì„</div>
                        
                        <div class="metadata-panel" style="padding: 0;">
                            <!-- Overview Card -->
                            <div class="metadata-card">
                                <div class="metadata-card-header"><h3>ğŸ“ˆ API ê°œìš”</h3></div>
                                <div class="metadata-card-body" id="dashboardOverview">
                                    <div class="loading"><div class="spinner"></div></div>
                                </div>
                            </div>
                            
                            <!-- Method Distribution Card -->
                            <div class="metadata-card">
                                <div class="metadata-card-header"><h3>ğŸ”§ HTTP ë©”ì„œë“œë³„</h3></div>
                                <div class="metadata-card-body" id="dashboardMethods">
                                    <div class="loading"><div class="spinner"></div></div>
                                </div>
                            </div>
                            
                            <!-- Logic Types Card -->
                            <div class="metadata-card">
                                <div class="metadata-card-header"><h3>âš¡ ë¡œì§ íƒ€ì…ë³„</h3></div>
                                <div class="metadata-card-body" id="dashboardLogicTypes">
                                    <div class="loading"><div class="spinner"></div></div>
                                </div>
                            </div>
                            
                            <!-- Recent Activity Card -->
                            <div class="metadata-card" style="grid-column: span 2;">
                                <div class="metadata-card-header"><h3>ğŸ“œ ìµœê·¼ í™œë™</h3></div>
                                <div class="metadata-card-body" id="dashboardActivity" style="max-height: 400px;">
                                    <div class="loading"><div class="spinner"></div></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="submit-btn" style="flex: 1;" onclick="loadDashboard()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                            <button class="submit-btn" style="flex: 1; background: linear-gradient(135deg, var(--accent-orange), var(--accent-pink));" onclick="exportApis()">ğŸ“¥ ì „ì²´ API ë‚´ë³´ë‚´ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add API Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <h2>â• ìƒˆ API ì¶”ê°€</h2>
                <button class="modal-close" onclick="closeAddModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="alert info">ğŸ”’ <strong>Immutable:</strong> ìƒì„± ì „ í…ŒìŠ¤íŠ¸ í•„ìˆ˜. ìƒì„± í›„ ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€.</div>
                <form id="createApiForm" onsubmit="return false;">
                    <div class="form-section">
                        <div class="form-section-title">ğŸ“ ë¼ìš°íŠ¸</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ê²½ë¡œ <span class="required">*</span></label>
                                <input type="text" class="form-input" id="newPath" placeholder="users/list" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ë©”ì„œë“œ</label>
                                <select class="form-select" id="newMethod"><option value="GET">GET</option><option value="POST">POST</option></select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ì´ë¦„ <span class="required">*</span></label>
                                <input type="text" class="form-input" id="newName" placeholder="ì‚¬ìš©ì ëª©ë¡" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">íƒœê·¸</label>
                                <input type="text" class="form-input" id="newTags" placeholder="users">
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <div class="form-section-title">ğŸ“¦ ë²„ì „ v1</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ë¡œì§ íƒ€ì…</label>
                                <select class="form-select" id="newLogicType"><option value="SQL">SQL</option><option value="MULTI_SQL">MULTI_SQL</option><option value="STATIC_RESPONSE">STATIC_RESPONSE</option></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ë³€ê²½ ë…¸íŠ¸</label>
                                <input type="text" class="form-input" id="newChangeNote" value="ì´ˆê¸° ë²„ì „">
                            </div>
                        </div>
                        <div class="form-row full">
                            <div class="form-group">
                                <label class="form-label">ìš”ì²­ ìŠ¤í™ (JSON)</label>
                                <textarea class="form-textarea" id="newRequestSpec" placeholder='{"limit": {"type": "int", "default": 10}}'></textarea>
                            </div>
                        </div>
                        <div class="form-row full">
                            <div class="form-group">
                                <label class="form-label">ë¡œì§ ë°”ë”” <span class="required">*</span></label>
                                <textarea class="form-textarea" id="newLogicBody" placeholder="SELECT * FROM table LIMIT :limit" required></textarea>
                            </div>
                        </div>
                        <div class="form-row full">
                            <div class="form-group">
                                <label class="form-label">ìƒ˜í”Œ íŒŒë¼ë¯¸í„° (JSON)</label>
                                <textarea class="form-textarea" id="newSampleParams" placeholder='{"limit": 10}'></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="test-section" id="newApiTestSection">
                        <div class="form-section-title">ğŸ§ª í…ŒìŠ¤íŠ¸ (í•„ìˆ˜)</div>
                        <button type="button" class="test-btn" onclick="testNewApi()">â–¶ SQL í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
                        <div class="test-result" id="newApiTestResult" style="display:none;"></div>
                    </div>
                    
                    <button type="button" class="submit-btn" onclick="createApi()" id="createApiBtn" disabled>âœ“ API ìƒì„± (í…ŒìŠ¤íŠ¸ í†µê³¼ í•„ìš”)</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let apis = [], selectedApi = null, routeData = null, versionData = null, auditData = [], tables = [];
        let llmModels = [], authMethods = {};
        const API_KEY = 'your-admin-api-key';
        let selectedTables = new Set();
        let responseData = null, viewMode = 'json';
        let newApiTestPassed = false, versionTestPassed = false;
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`)?.classList.add('active');
            document.getElementById(`tab-${tab}`)?.classList.add('active');
            if (tab === 'llm' && tables.length === 0) { loadTables(); loadLLMModels(); }
            if (tab === 'dashboard') { loadDashboard(); }
            if (tab === 'ai-features') { initAiFeatures(); }
        }
        
        function openAddModal() { document.getElementById('addModal').classList.add('active'); newApiTestPassed = false; updateCreateBtn(); }
        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }
        function updateCreateBtn() { document.getElementById('createApiBtn').disabled = !newApiTestPassed; document.getElementById('createApiBtn').textContent = newApiTestPassed ? 'âœ“ API ìƒì„±' : 'âœ“ API ìƒì„± (í…ŒìŠ¤íŠ¸ í†µê³¼ í•„ìš”)'; }
        
        async function loadApis() {
            try {
                const res = await fetch('/admin/routes?size=100');
                const data = await res.json();
                apis = data.data || [];
                renderApiList();
            } catch (e) { console.error('API ë¡œë“œ ì‹¤íŒ¨:', e); }
        }
        
        function renderApiList(filter = '') {
            const container = document.getElementById('apiList');
            const groups = {};
            apis.forEach(api => {
                if (filter && !api.path.toLowerCase().includes(filter.toLowerCase()) && !api.name?.toLowerCase().includes(filter.toLowerCase())) return;
                const group = api.path.split('/')[0] || 'other';
                if (!groups[group]) groups[group] = [];
                groups[group].push(api);
            });
            let html = '';
            for (const [group, items] of Object.entries(groups)) {
                html += `<div class="api-group"><div class="api-group-header">${group} (${items.length})</div>`;
                items.forEach(api => {
                    html += `<div class="api-item" onclick="selectApi('${api.id}')" id="api-${api.id}" ${api.is_active ? '' : 'style="opacity:0.5"'}>
                        <span class="method-badge ${api.method.toLowerCase()}">${api.method}</span>
                        <div class="api-item-info"><div class="api-item-path">/api/${api.path}</div><div class="api-item-name">${api.name || ''}</div></div></div>`;
                });
                html += '</div>';
            }
            container.innerHTML = html || '<div class="empty-state"><div class="empty-state-text">APIê°€ ì—†ìŠµë‹ˆë‹¤</div></div>';
        }
        
        async function selectApi(id) {
            document.querySelectorAll('.api-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`api-${id}`)?.classList.add('active');
            selectedApi = apis.find(a => a.id === id);
            if (!selectedApi) return;
            await Promise.all([loadRouteData(id), loadVersionData(id), loadAuditData(id)]);
            updateUI(); updateMetadataPanel(); updateAddVersionForm();
        }
        
        async function loadRouteData(id) { try { const res = await fetch(`/admin/routes/${id}`); routeData = (await res.json()).data; } catch { routeData = null; }}
        async function loadVersionData(id) {
            try {
                const res = await fetch(`/admin/routes/${id}/versions`);
                const versions = (await res.json()).data || [];
                const current = versions.find(v => v.is_current) || versions[0];
                if (current) { const detail = await fetch(`/admin/routes/${id}/versions/${current.version}`); versionData = (await detail.json()).data; selectedApi.version = versionData; }
            } catch { versionData = null; }
        }
        async function loadAuditData(id) { try { const res = await fetch(`/admin/routes/${id}/audit-logs?limit=10`); auditData = (await res.json()).data || []; } catch { auditData = []; }}
        
        function updateUI() {
            if (!selectedApi) return;
            document.getElementById('apiTitle').textContent = selectedApi.name || selectedApi.path;
            document.getElementById('urlPath').value = `/api/${selectedApi.path}`;
            const lt = document.getElementById('logicType');
            if (selectedApi.version?.logic_type) { lt.textContent = selectedApi.version.logic_type; lt.style.display = 'inline'; } else { lt.style.display = 'none'; }
            
            const reqSpec = selectedApi.version?.request_spec || {};
            const sampleParams = selectedApi.version?.sample_params || {};
            let html = '';
            for (const [key, spec] of Object.entries(reqSpec)) {
                const def = sampleParams[key] !== undefined ? sampleParams[key] : (spec.default !== undefined ? spec.default : '');
                html += `<div class="param-row"><input type="text" value="${key}" readonly style="background:var(--bg-secondary)"><input type="text" id="param-${key}" value="${def}" placeholder="${spec.description || 'Value'}"><select disabled><option>${spec.type || 'string'}</option></select>${spec.required ? '<span class="param-required">*</span>' : ''}</div>`;
            }
            document.getElementById('paramsGrid').innerHTML = html || '<div style="color:var(--text-secondary);font-size:12px">íŒŒë¼ë¯¸í„° ì—†ìŒ</div>';
            document.getElementById('sampleBtn').style.display = Object.keys(sampleParams).length > 0 ? 'inline-block' : 'none';
            document.getElementById('responseBody').innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¡</div><div class="empty-state-text">Send a request</div></div>';
            document.getElementById('responseStatus').style.display = 'none';
            document.getElementById('viewToggle').style.display = 'none';
        }
        
        function fillSampleParams() {
            const sampleParams = selectedApi?.version?.sample_params || {};
            for (const [key, val] of Object.entries(sampleParams)) {
                const input = document.getElementById(`param-${key}`);
                if (input) input.value = val;
            }
        }
        
        function updateAddVersionForm() {
            const container = document.getElementById('addVersionForm');
            if (!selectedApi) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¦</div><div class="empty-state-text">APIë¥¼ ì„ íƒí•˜ì„¸ìš”</div></div>'; return; }
            versionTestPassed = false;
            const nextV = (versionData?.version || 0) + 1;
            container.innerHTML = `<form onsubmit="return false;">
                <div class="form-row"><div class="form-group"><label class="form-label">API</label><input class="form-input" value="/api/${selectedApi.path}" readonly style="background:var(--bg-secondary)"></div><div class="form-group"><label class="form-label">ë²„ì „</label><input class="form-input" value="v${nextV}" readonly style="background:var(--bg-secondary)"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">ë¡œì§ íƒ€ì…</label><select class="form-select" id="versionLogicType"><option value="SQL" ${versionData?.logic_type==='SQL'?'selected':''}>SQL</option><option value="MULTI_SQL" ${versionData?.logic_type==='MULTI_SQL'?'selected':''}>MULTI_SQL</option><option value="STATIC_RESPONSE" ${versionData?.logic_type==='STATIC_RESPONSE'?'selected':''}>STATIC_RESPONSE</option></select></div><div class="form-group"><label class="form-label">ë³€ê²½ ë…¸íŠ¸ <span class="required">*</span></label><input class="form-input" id="versionChangeNote" required></div></div>
                <div class="form-row full"><div class="form-group"><label class="form-label">ìš”ì²­ ìŠ¤í™ (JSON)</label><textarea class="form-textarea" id="versionRequestSpec">${formatJson(versionData?.request_spec)}</textarea></div></div>
                <div class="form-row full"><div class="form-group"><label class="form-label">ë¡œì§ ë°”ë”” <span class="required">*</span></label><textarea class="form-textarea" id="versionLogicBody" required>${escapeHtml(versionData?.logic_body||'')}</textarea></div></div>
                <div class="form-row full"><div class="form-group"><label class="form-label">ìƒ˜í”Œ íŒŒë¼ë¯¸í„° (JSON)</label><textarea class="form-textarea" id="versionSampleParams">${formatJson(versionData?.sample_params)}</textarea></div></div>
                <div class="test-section" id="versionTestSection">
                    <div class="form-section-title">ğŸ§ª í…ŒìŠ¤íŠ¸ (í•„ìˆ˜)</div>
                    <button type="button" class="test-btn" onclick="testVersion()">â–¶ SQL í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
                    <div class="test-result" id="versionTestResult" style="display:none;"></div>
                </div>
                <button type="button" class="submit-btn" onclick="createVersion()" id="createVersionBtn" disabled>âœ“ v${nextV} ìƒì„± (í…ŒìŠ¤íŠ¸ í†µê³¼ í•„ìš”)</button></form>`;
        }
        
        async function testNewApi() { await runTest('newApiTestResult', 'newLogicBody', 'newSampleParams', 'newApiTestSection', (ok) => { newApiTestPassed = ok; updateCreateBtn(); }); }
        async function testVersion() { await runTest('versionTestResult', 'versionLogicBody', 'versionSampleParams', 'versionTestSection', (ok) => { versionTestPassed = ok; document.getElementById('createVersionBtn').disabled = !ok; document.getElementById('createVersionBtn').textContent = ok ? 'âœ“ v' + ((versionData?.version || 0) + 1) + ' ìƒì„±' : 'âœ“ ìƒì„± (í…ŒìŠ¤íŠ¸ í†µê³¼ í•„ìš”)'; }); }
        
        async function runTest(resultId, bodyId, paramsId, sectionId, callback) {
            const resultEl = document.getElementById(resultId);
            const sectionEl = document.getElementById(sectionId);
            resultEl.style.display = 'block';
            resultEl.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            sectionEl.classList.remove('success', 'error');
            
            const logicBody = document.getElementById(bodyId).value.trim();
            let params = {};
            try { const t = document.getElementById(paramsId).value.trim(); if (t) params = JSON.parse(t); } catch { resultEl.innerHTML = '<span style="color:var(--accent-red)">ìƒ˜í”Œ íŒŒë¼ë¯¸í„° JSON ì˜¤ë¥˜</span>'; callback(false); return; }
            
            try {
                const res = await fetch('/schema/test-sql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ logic_type: 'SQL', logic_body: logicBody, params }) });
                const data = await res.json();
                if (data.data?.success) {
                    sectionEl.classList.add('success');
                    resultEl.innerHTML = `<span style="color:var(--accent-green)">âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ (${data.data.row_count}í–‰, ${data.data.execution_time_ms}ms)</span><br><pre style="margin-top:8px;color:var(--text-secondary)">${JSON.stringify(data.data.data?.slice(0,3), null, 2)}</pre>`;
                    callback(true);
                } else {
                    sectionEl.classList.add('error');
                    resultEl.innerHTML = `<span style="color:var(--accent-red)">âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨</span><br><pre style="margin-top:8px">${data.data?.error || 'Unknown error'}</pre>`;
                    callback(false);
                }
            } catch (e) {
                sectionEl.classList.add('error');
                resultEl.innerHTML = `<span style="color:var(--accent-red)">âŒ ìš”ì²­ ì‹¤íŒ¨: ${e.message}</span>`;
                callback(false);
            }
        }
        
        function updateMetadataPanel() {
            const panel = document.getElementById('metadataPanel');
            if (!selectedApi) { panel.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><div class="empty-state-text">APIë¥¼ ì„ íƒí•˜ì„¸ìš”</div></div>'; return; }
            let html = '';
            if (routeData) html += `<div class="metadata-card"><div class="metadata-card-header"><span>ğŸ“</span><h3>Route</h3><span class="table-badge">APP_API_ROUTE_L</span></div><div class="metadata-card-body"><div class="info-grid"><div class="info-row"><span class="info-label">ROUTE_ID</span><span class="info-value">${routeData.id}</span></div><div class="info-row"><span class="info-label">PATH</span><span class="info-value">${routeData.path}</span></div><div class="info-row"><span class="info-label">METHOD</span><span class="info-value"><span class="badge blue">${routeData.method}</span></span></div><div class="info-row"><span class="info-label">NAME</span><span class="info-value">${routeData.name||'-'}</span></div><div class="info-row"><span class="info-label">USE_YN</span><span class="info-value"><span class="badge ${routeData.is_active?'green':'red'}">${routeData.is_active?'Y':'N'}</span></span></div></div></div></div>`;
            if (versionData) html += `<div class="metadata-card"><div class="metadata-card-header"><span>ğŸ“¦</span><h3>Version</h3><span class="table-badge">APP_API_VERSION_H</span></div><div class="metadata-card-body"><div class="info-grid"><div class="info-row"><span class="info-label">VERSION_NO</span><span class="info-value"><span class="badge purple">v${versionData.version}</span></span></div><div class="info-row"><span class="info-label">LOGIC_TYPE</span><span class="info-value"><span class="badge blue">${versionData.logic_type}</span></span></div><div class="info-row"><span class="info-label">REQ_SPEC</span><div class="info-value code">${formatJson(versionData.request_spec)||'-'}</div></div><div class="info-row"><span class="info-label">LOGIC_BODY</span><div class="info-value code">${escapeHtml(versionData.logic_body)||'-'}</div></div><div class="info-row"><span class="info-label">SMPL_PARAMS</span><div class="info-value code">${formatJson(versionData.sample_params)||'-'}</div></div></div></div></div>`;
            html += `<div class="metadata-card"><div class="metadata-card-header"><span>ğŸ“œ</span><h3>Audit</h3><span class="table-badge">APP_API_AUDIT_H</span></div><div class="metadata-card-body"><div class="audit-list">${auditData.length ? auditData.map(l => `<div class="audit-item ${l.action}"><div class="audit-header"><span class="audit-action">${l.action}</span><span class="audit-time">${formatDate(l.created_at)}</span></div><div class="audit-details">${l.actor||''} ${l.actor_ip?`(${l.actor_ip})`:''}</div></div>`).join('') : '<div style="color:var(--text-secondary);text-align:center;padding:16px">ë¡œê·¸ ì—†ìŒ</div>'}</div></div></div>`;
            panel.innerHTML = html;
        }
        
        async function loadTables() {
            try {
                const res = await fetch('/schema/tables');
                tables = (await res.json()).data || [];
                renderTableSelector();
            } catch (e) { console.error('í…Œì´ë¸” ë¡œë“œ ì‹¤íŒ¨:', e); }
        }
        
        async function loadLLMModels() {
            try {
                const res = await fetch('/schema/llm/models');
                const data = (await res.json()).data;
                llmModels = data.models || [];
                authMethods = data.auth_methods || {};
                renderLLMModels();
            } catch (e) { console.error('LLM ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:', e); }
        }
        
        function renderLLMModels() {
            const select = document.getElementById('llmModel');
            const byProvider = {};
            llmModels.forEach(m => {
                if (!byProvider[m.provider]) byProvider[m.provider] = [];
                byProvider[m.provider].push(m);
            });
            let html = '';
            // Vertex AIë¥¼ ë¨¼ì € í‘œì‹œ
            const providerOrder = ['vertex_ai', 'google', 'openai', 'anthropic', 'mistral', 'groq', 'together_ai', 'azure', 'bedrock', 'ollama', 'openrouter'];
            const sortedProviders = [...new Set([...providerOrder, ...Object.keys(byProvider)])].filter(p => byProvider[p]);
            
            for (const prov of sortedProviders) {
                const models = byProvider[prov];
                if (!models) continue;
                html += `<optgroup label="${prov.toUpperCase()}">`;
                models.forEach(m => { 
                    const isDefault = m.id === 'vertex_ai/gemini-2.5-flash';
                    html += `<option value="${m.id}" data-auth="${m.auth}" ${isDefault ? 'selected' : ''}>${m.name}</option>`; 
                });
                html += '</optgroup>';
            }
            select.innerHTML = html;
            // Gemini 2.0 Flashë¥¼ ê¸°ë³¸ ì„ íƒ
            select.value = 'vertex_ai/gemini-2.5-flash';
            updateAuthFields();
        }
        
        function updateAuthFields() {
            const select = document.getElementById('llmModel');
            const option = select.options[select.selectedIndex];
            const authType = option?.dataset.auth || 'api_key';
            const method = authMethods[authType];
            
            const container = document.getElementById('authFields');
            
            // Vertex AIì˜ ê²½ìš° gcloud-key.json ìë™ ì‚¬ìš© ì•ˆë‚´
            if (authType === 'vertex') {
                container.innerHTML = `
                    <div class="alert success" style="margin:0;">
                        âœ… <strong>gcloud-key.json ìë™ ì¸ì¦</strong><br>
                        <span style="font-size:11px;">í”„ë¡œì íŠ¸ì— ìˆëŠ” gcloud-key.json íŒŒì¼ì´ ìë™ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.<br>
                        ì¶”ê°€ ì…ë ¥ ì—†ì´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
                    </div>`;
                return;
            }
            
            if (!method) { container.innerHTML = ''; return; }
            
            let html = `<p style="font-size:11px;color:var(--text-secondary);margin-bottom:10px;">${method.description}</p><div class="form-row">`;
            method.fields.forEach(f => {
                if (f.type === 'textarea') {
                    html += `<div class="form-group" style="grid-column:1/-1"><label class="form-label">${f.label}${f.required ? ' <span class="required">*</span>' : ''}</label><textarea class="form-textarea" id="auth_${f.name}" placeholder="${f.default || ''}" style="min-height:60px;"></textarea></div>`;
                } else {
                    html += `<div class="form-group"><label class="form-label">${f.label}${f.required ? ' <span class="required">*</span>' : ''}</label><input type="${f.type}" class="form-input" id="auth_${f.name}" placeholder="${f.default || ''}"></div>`;
                }
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderTableSelector() {
            const container = document.getElementById('tableSelector');
            container.innerHTML = tables.map(t => `<div class="table-item" onclick="toggleTable('${t.table_name}')" id="table-${t.table_name}"><div class="table-item-name">${t.table_name}</div><div class="table-item-info">${t.row_count?.toLocaleString() || 0} rows</div></div>`).join('');
        }
        
        async function toggleTable(name) {
            const el = document.getElementById(`table-${name}`);
            if (selectedTables.has(name)) { selectedTables.delete(name); el.classList.remove('selected'); }
            else { selectedTables.add(name); el.classList.add('selected'); }
            await updateSchemaPreview();
        }
        
        async function updateSchemaPreview() {
            const section = document.getElementById('schemaPreviewSection');
            const container = document.getElementById('schemaPreview');
            if (selectedTables.size === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            let html = '';
            for (const name of selectedTables) {
                try {
                    const res = await fetch(`/schema/tables/${name}?sample_limit=5`);
                    const data = (await res.json()).data;
                    const colSamples = data.column_samples || {};
                    
                    html += `<div class="schema-table"><div class="schema-table-name">${name}</div><div class="schema-columns">`;
                    data.columns.forEach(c => {
                        const samples = colSamples[c.name] || [];
                        const sampleStr = samples.slice(0, 3).map(v => JSON.stringify(v)).join(', ');
                        html += `<div class="schema-column"><span class="schema-column-name">${c.name} ${c.key ? `<span style="color:var(--accent-orange)">[${c.key}]</span>` : ''}</span><span class="schema-column-type">${c.type}</span><span class="schema-column-sample" title="${escapeHtml(sampleStr)}">${escapeHtml(sampleStr) || '-'}</span></div>`;
                    });
                    html += '</div></div>';
                } catch {}
            }
            container.innerHTML = html;
        }
        
        async function generateWithLLM() {
            if (selectedTables.size === 0) { alert('í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
            const intent = document.getElementById('llmIntent').value.trim();
            if (!intent) { alert('ì˜ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
            
            const btn = document.getElementById('llmGenerateBtn');
            btn.disabled = true; btn.textContent = 'ğŸ”„ ìƒì„± ì¤‘...';
            document.getElementById('llmResult').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            const body = {
                user_intent: intent,
                table_names: Array.from(selectedTables),
                method: document.getElementById('llmMethod').value,
                model: document.getElementById('llmModel').value,
                temperature: parseFloat(document.getElementById('llmTemp').value),
                max_tokens: parseInt(document.getElementById('llmMaxTokens').value),
                top_p: parseFloat(document.getElementById('llmTopP').value),
            };
            
            // ì¸ì¦ ì •ë³´ ì¶”ê°€
            const apiKeyEl = document.getElementById('auth_api_key');
            if (apiKeyEl?.value) body.api_key = apiKeyEl.value;
            const apiBaseEl = document.getElementById('auth_api_base');
            if (apiBaseEl?.value) body.api_base = apiBaseEl.value;
            const vertexEl = document.getElementById('auth_vertex_credentials');
            if (vertexEl?.value) body.vertex_credentials = vertexEl.value;
            
            try {
                const res = await fetch('/schema/llm/generate-api', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const result = await res.json();
                if (!res.ok) throw new Error(result.detail?.message || 'LLM í˜¸ì¶œ ì‹¤íŒ¨');
                
                const spec = result.data;
                document.getElementById('llmResult').innerHTML = `<div class="generated-result"><h4>âœ… ìƒì„±ëœ API ìŠ¤í™</h4>
                    <div class="generated-field"><div class="generated-field-label">ê²½ë¡œ</div><div class="generated-field-value">${spec.method} /api/${spec.path}</div></div>
                    <div class="generated-field"><div class="generated-field-label">ì´ë¦„</div><div class="generated-field-value">${spec.name}</div></div>
                    <div class="generated-field"><div class="generated-field-label">ì„¤ëª…</div><div class="generated-field-value">${spec.description}</div></div>
                    <div class="generated-field"><div class="generated-field-label">ìš”ì²­ ìŠ¤í™</div><div class="generated-field-value">${formatJson(spec.request_spec)}</div></div>
                    <div class="generated-field"><div class="generated-field-label">ë¡œì§</div><div class="generated-field-value">${escapeHtml(spec.logic_body)}</div></div>
                    <div class="generated-field"><div class="generated-field-label">ìƒ˜í”Œ íŒŒë¼ë¯¸í„°</div><div class="generated-field-value">${formatJson(spec.sample_params)}</div></div>
                    <button class="submit-btn" onclick="applyGeneratedSpec(${JSON.stringify(spec).replace(/"/g, '&quot;')})">âœ“ ì´ ìŠ¤í™ìœ¼ë¡œ API ìƒì„±</button></div>`;
            } catch (e) {
                document.getElementById('llmResult').innerHTML = `<div class="alert warning">âŒ ${e.message}</div>`;
            } finally {
                btn.disabled = false; btn.textContent = 'ğŸ¤– API ìƒì„±';
            }
        }
        
        function applyGeneratedSpec(spec) {
            document.getElementById('newPath').value = spec.path;
            document.getElementById('newMethod').value = spec.method;
            document.getElementById('newName').value = spec.name;
            document.getElementById('newTags').value = spec.tags || '';
            document.getElementById('newLogicType').value = spec.logic_type;
            document.getElementById('newLogicBody').value = spec.logic_body;
            document.getElementById('newRequestSpec').value = formatJson(spec.request_spec);
            document.getElementById('newSampleParams').value = formatJson(spec.sample_params);
            document.getElementById('newChangeNote').value = spec.change_note || 'ì´ˆê¸° ë²„ì „';
            openAddModal();
        }
        
        async function createApi() {
            if (!newApiTestPassed) { alert('ë¨¼ì € í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•´ì•¼ í•©ë‹ˆë‹¤.'); return; }
            const path = document.getElementById('newPath').value.trim();
            const method = document.getElementById('newMethod').value;
            const name = document.getElementById('newName').value.trim();
            const tags = document.getElementById('newTags').value.trim();
            const logicType = document.getElementById('newLogicType').value;
            const logicBody = document.getElementById('newLogicBody').value.trim();
            const changeNote = document.getElementById('newChangeNote').value.trim() || 'ì´ˆê¸° ë²„ì „';
            let requestSpec = null, sampleParams = null;
            try { const t = document.getElementById('newRequestSpec').value.trim(); if (t) requestSpec = JSON.parse(t); } catch { alert('ìš”ì²­ ìŠ¤í™ JSON ì˜¤ë¥˜'); return; }
            try { const t = document.getElementById('newSampleParams').value.trim(); if (t) sampleParams = JSON.parse(t); } catch { alert('ìƒ˜í”Œ íŒŒë¼ë¯¸í„° JSON ì˜¤ë¥˜'); return; }
            
            try {
                const routeRes = await fetch('/admin/routes', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-API-Key': API_KEY }, body: JSON.stringify({ path, method, name, tags: tags || null }) });
                if (!routeRes.ok) throw new Error((await routeRes.json()).detail?.message || 'API ìƒì„± ì‹¤íŒ¨');
                const routeId = (await routeRes.json()).data.id;
                
                const versionRes = await fetch(`/admin/routes/${routeId}/versions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-API-Key': API_KEY }, body: JSON.stringify({ route_id: routeId, logic_type: logicType, logic_body: logicBody, request_spec: requestSpec, sample_params: sampleParams, change_note: changeNote }) });
                if (!versionRes.ok) throw new Error((await versionRes.json()).detail?.message || 'ë²„ì „ ìƒì„± ì‹¤íŒ¨');
                
                alert('âœ… API ìƒì„± ì™„ë£Œ!');
                closeAddModal();
                document.getElementById('createApiForm').reset();
                newApiTestPassed = false; updateCreateBtn();
                await loadApis();
                await selectApi(routeId);
            } catch (e) { alert('âŒ ' + e.message); }
        }
        
        async function createVersion() {
            if (!versionTestPassed) { alert('ë¨¼ì € í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•´ì•¼ í•©ë‹ˆë‹¤.'); return; }
            if (!selectedApi) return;
            const logicType = document.getElementById('versionLogicType').value;
            const changeNote = document.getElementById('versionChangeNote').value.trim();
            const logicBody = document.getElementById('versionLogicBody').value.trim();
            let requestSpec = null, sampleParams = null;
            try { const t = document.getElementById('versionRequestSpec').value.trim(); if (t) requestSpec = JSON.parse(t); } catch { alert('JSON ì˜¤ë¥˜'); return; }
            try { const t = document.getElementById('versionSampleParams').value.trim(); if (t) sampleParams = JSON.parse(t); } catch { alert('JSON ì˜¤ë¥˜'); return; }
            
            try {
                const res = await fetch(`/admin/routes/${selectedApi.id}/versions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-API-Key': API_KEY }, body: JSON.stringify({ route_id: selectedApi.id, logic_type: logicType, logic_body: logicBody, request_spec: requestSpec, sample_params: sampleParams, change_note: changeNote }) });
                if (!res.ok) throw new Error((await res.json()).detail?.message || 'ë²„ì „ ìƒì„± ì‹¤íŒ¨');
                const result = await res.json();
                alert(`âœ… v${result.data.version} ìƒì„± ì™„ë£Œ!`);
                await selectApi(selectedApi.id);
                switchTab('metadata');
            } catch (e) { alert('âŒ ' + e.message); }
        }
        
        async function sendRequest() {
            if (!selectedApi) { alert('APIë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
            const responseBody = document.getElementById('responseBody');
            responseBody.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            const startTime = performance.now();
            try {
                const params = {};
                const reqSpec = selectedApi.version?.request_spec || {};
                for (const key of Object.keys(reqSpec)) {
                    const input = document.getElementById(`param-${key}`);
                    if (input?.value) {
                        const spec = reqSpec[key];
                        let val = input.value;
                        if (spec.type === 'int') val = parseInt(val);
                        else if (spec.type === 'float') val = parseFloat(val);
                        else if (spec.type === 'bool') val = val === 'true';
                        params[key] = val;
                    }
                }
                let url = `/api/${selectedApi.path}`;
                let response;
                if (selectedApi.method === 'GET') {
                    const qs = new URLSearchParams(params).toString();
                    if (qs) url += '?' + qs;
                    response = await fetch(url);
                } else {
                    response = await fetch(url, { method: selectedApi.method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(params) });
                }
                responseData = await response.json();
                const duration = Math.round(performance.now() - startTime);
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = response.status;
                statusBadge.className = 'status-badge ' + (response.ok ? 'success' : 'error');
                document.getElementById('responseTime').textContent = `${duration}ms`;
                document.getElementById('responseStatus').style.display = 'flex';
                document.getElementById('viewToggle').style.display = 'flex';
                renderResponse();
            } catch (e) { responseBody.innerHTML = `<pre style="color:var(--accent-red)">Error: ${e.message}</pre>`; }
        }
        
        function setViewMode(mode) {
            viewMode = mode;
            document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.view-toggle button:${mode === 'json' ? 'first' : 'last'}-child`).classList.add('active');
            renderResponse();
        }
        
        function renderResponse() {
            const container = document.getElementById('responseBody');
            if (!responseData) return;
            if (viewMode === 'json') {
                container.innerHTML = '<pre>' + syntaxHighlight(JSON.stringify(responseData, null, 2)) + '</pre>';
            } else {
                container.innerHTML = '<div class="table-view">' + renderAsTable(responseData) + '</div>';
            }
        }
        
        function renderAsTable(data, title = '') {
            if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object') {
                const cols = Object.keys(data[0]);
                let html = title ? `<div class="table-title">${title}</div>` : '';
                html += '<table class="data-table"><thead><tr>';
                cols.forEach(c => html += `<th>${c}</th>`);
                html += '</tr></thead><tbody>';
                data.forEach(row => {
                    html += '<tr>';
                    cols.forEach(c => {
                        let val = row[c];
                        if (typeof val === 'object' && val !== null) val = JSON.stringify(val);
                        html += `<td title="${escapeHtml(String(val))}">${escapeHtml(String(val ?? ''))}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
                return html;
            } else if (typeof data === 'object' && data !== null) {
                let html = '';
                for (const [key, val] of Object.entries(data)) {
                    if (Array.isArray(val) && val.length > 0 && typeof val[0] === 'object') {
                        html += renderAsTable(val, key);
                    } else if (typeof val === 'object' && val !== null && !Array.isArray(val)) {
                        html += renderAsTable(val, key);
                    }
                }
                if (!html) html = '<pre>' + syntaxHighlight(JSON.stringify(data, null, 2)) + '</pre>';
                return html;
            }
            return '<pre>' + escapeHtml(String(data)) + '</pre>';
        }
        
        function formatDate(str) { return str ? new Date(str).toLocaleString('ko-KR') : '-'; }
        function formatJson(obj) { try { return obj ? JSON.stringify(obj, null, 2) : ''; } catch { return ''; }}
        function escapeHtml(str) { return str ? str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }
        function syntaxHighlight(json) {
            return json.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, m => {
                let cls = 'json-number';
                if (/^"/.test(m)) cls = /:$/.test(m) ? 'json-key' : 'json-string';
                else if (/true|false/.test(m)) cls = 'json-boolean';
                else if (/null/.test(m)) cls = 'json-null';
                return `<span class="${cls}">${m}</span>`;
            });
        }
        
        // Dashboard Functions
        async function loadDashboard() {
            try {
                // Load Overview Stats
                const statsRes = await fetch('/admin/stats/overview');
                const statsData = await statsRes.json();
                const stats = statsData.data;
                
                document.getElementById('dashboardOverview').innerHTML = `
                    <div class="info-grid">
                        <div class="info-row"><span class="info-label">ì´ API ìˆ˜</span><span class="info-value"><strong>${stats.total_apis}</strong></span></div>
                        <div class="info-row"><span class="info-label">í™œì„±í™”</span><span class="info-value"><span class="badge green">${stats.active_apis}</span></span></div>
                        <div class="info-row"><span class="info-label">ë¹„í™œì„±í™”</span><span class="info-value"><span class="badge red">${stats.inactive_apis}</span></span></div>
                        <div class="info-row"><span class="info-label">ì´ ë²„ì „ ìˆ˜</span><span class="info-value">${stats.total_versions}</span></div>
                        <div class="info-row"><span class="info-label">ìµœê·¼ 7ì¼ ìƒì„±</span><span class="info-value"><span class="badge blue">${stats.recent_apis_7d}</span></span></div>
                    </div>`;
                
                // Methods
                let methodsHtml = '<div class="info-grid">';
                for (const [method, count] of Object.entries(stats.by_method || {})) {
                    const color = method === 'GET' ? 'green' : method === 'POST' ? 'blue' : 'purple';
                    methodsHtml += `<div class="info-row"><span class="info-label">${method}</span><span class="info-value"><span class="badge ${color}">${count}</span></span></div>`;
                }
                methodsHtml += '</div>';
                document.getElementById('dashboardMethods').innerHTML = methodsHtml;
                
                // Logic Types
                let logicHtml = '<div class="info-grid">';
                for (const [type, count] of Object.entries(stats.by_logic_type || {})) {
                    logicHtml += `<div class="info-row"><span class="info-label">${type}</span><span class="info-value">${count}</span></div>`;
                }
                logicHtml += '</div>';
                document.getElementById('dashboardLogicTypes').innerHTML = logicHtml;
                
                // Load Audit Summary
                const auditRes = await fetch('/admin/stats/audit-summary?days=7');
                const auditData = await auditRes.json();
                const audit = auditData.data;
                
                let activityHtml = '<div class="audit-list">';
                for (const log of (audit.recent_activity || [])) {
                    activityHtml += `<div class="audit-item ${log.action}">
                        <div class="audit-header">
                            <span class="audit-action">${log.action}</span>
                            <span class="audit-time">${formatDate(log.created_at)}</span>
                        </div>
                        <div class="audit-details">Route: ${log.route_id || '-'} | Actor: ${log.actor || '-'}</div>
                    </div>`;
                }
                activityHtml += '</div>';
                document.getElementById('dashboardActivity').innerHTML = activityHtml || '<div class="empty-state">ìµœê·¼ í™œë™ ì—†ìŒ</div>';
                
            } catch (e) {
                console.error('Dashboard load error:', e);
                document.getElementById('dashboardOverview').innerHTML = '<div class="empty-state">ë¡œë”© ì‹¤íŒ¨</div>';
            }
        }
        
        async function exportApis() {
            try {
                const res = await fetch('/admin/export?include_inactive=true');
                const data = await res.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `api-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`âœ… ${data.total_apis}ê°œ APIê°€ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (e) {
                console.error('Export error:', e);
                alert('âŒ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + e.message);
            }
        }
        
        document.getElementById('searchInput').addEventListener('input', e => renderApiList(e.target.value));
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAddModal(); });
        
        // ==================== AI Features ====================
        let optimizeSelectedTables = new Set();
        
        function showAiSubTab(tab) {
            // Update sub-tab buttons
            document.querySelectorAll('[id^="aiSubTab-"]').forEach(btn => {
                btn.style.background = 'var(--bg-tertiary)';
                btn.style.border = '1px solid var(--border-color)';
            });
            const activeBtn = document.getElementById(`aiSubTab-${tab}`);
            activeBtn.style.background = 'var(--accent-purple)';
            activeBtn.style.border = 'none';
            
            // Show selected panel
            document.querySelectorAll('.ai-sub-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`aiPanel-${tab}`).style.display = 'block';
            
            // Initialize specific panels
            if (tab === 'optimize') initOptimizePanel();
            if (tab === 'testcase') initTestcasePanel();
            if (tab === 'chat') initChatPanel();
        }
        
        function initChatPanel() {
            const select = document.getElementById('chatLlmModel');
            if (select.innerHTML) return;
            populateLlmModelSelect(select);
        }
        
        function initOptimizePanel() {
            const select = document.getElementById('optimizeLlmModel');
            if (!select.innerHTML) populateLlmModelSelect(select);
            
            const container = document.getElementById('optimizeTableSelector');
            if (tables.length === 0) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
                loadTables().then(() => renderOptimizeTables());
            } else {
                renderOptimizeTables();
            }
        }
        
        function renderOptimizeTables() {
            const container = document.getElementById('optimizeTableSelector');
            container.innerHTML = tables.map(t => 
                `<div class="table-item" onclick="toggleOptimizeTable('${t.table_name}')" id="optimize-table-${t.table_name}">
                    <div class="table-item-name">${t.table_name}</div>
                </div>`
            ).join('');
        }
        
        function toggleOptimizeTable(name) {
            const el = document.getElementById(`optimize-table-${name}`);
            if (optimizeSelectedTables.has(name)) {
                optimizeSelectedTables.delete(name);
                el.classList.remove('selected');
            } else {
                optimizeSelectedTables.add(name);
                el.classList.add('selected');
            }
        }
        
        function initTestcasePanel() {
            const select = document.getElementById('testcaseLlmModel');
            if (!select.innerHTML) populateLlmModelSelect(select);
            
            const apiSelect = document.getElementById('testcaseApiSelect');
            if (apiSelect.options.length <= 1) {
                apis.forEach(api => {
                    const opt = document.createElement('option');
                    opt.value = api.id;
                    opt.textContent = `${api.method} /api/${api.path} - ${api.name || ''}`;
                    apiSelect.appendChild(opt);
                });
            }
            
            apiSelect.onchange = async () => {
                const apiId = apiSelect.value;
                const infoDiv = document.getElementById('testcaseApiInfo');
                if (!apiId) {
                    infoDiv.style.display = 'none';
                    return;
                }
                
                const api = apis.find(a => a.id === apiId);
                if (!api) return;
                
                // Load version data
                try {
                    const res = await fetch(`/admin/routes/${apiId}/versions`);
                    const versions = (await res.json()).data || [];
                    const current = versions.find(v => v.is_current) || versions[0];
                    
                    document.getElementById('testcaseApiPath').textContent = `${api.method} /api/${api.path}`;
                    document.getElementById('testcaseApiLogic').textContent = current?.logic_body?.substring(0, 200) || '-';
                    infoDiv.style.display = 'block';
                } catch (e) {
                    console.error(e);
                }
            };
        }
        
        function populateLlmModelSelect(select) {
            if (!llmModels.length) {
                loadLLMModels().then(() => doPopulate(select));
            } else {
                doPopulate(select);
            }
            
            function doPopulate(sel) {
                const byProvider = {};
                llmModels.forEach(m => {
                    if (!byProvider[m.provider]) byProvider[m.provider] = [];
                    byProvider[m.provider].push(m);
                });
                
                let html = '';
                const providerOrder = ['vertex_ai', 'google', 'openai', 'anthropic'];
                const sortedProviders = [...new Set([...providerOrder, ...Object.keys(byProvider)])].filter(p => byProvider[p]);
                
                for (const prov of sortedProviders) {
                    const models = byProvider[prov];
                    if (!models) continue;
                    html += `<optgroup label="${prov.toUpperCase()}">`;
                    models.forEach(m => {
                        const isDefault = m.id === 'vertex_ai/gemini-2.5-flash';
                        html += `<option value="${m.id}" ${isDefault ? 'selected' : ''}>${m.name}</option>`;
                    });
                    html += '</optgroup>';
                }
                sel.innerHTML = html;
                sel.value = 'vertex_ai/gemini-2.5-flash';
            }
        }
        
        // Chat API
        async function sendChatQuery() {
            const question = document.getElementById('chatQuestion').value.trim();
            if (!question) { alert('ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
            
            const resultDiv = document.getElementById('chatResult');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const res = await fetch('/schema/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question,
                        auto_execute: document.getElementById('chatAutoExecute').value === 'true',
                        model: document.getElementById('chatLlmModel').value
                    })
                });
                
                if (!res.ok) throw new Error((await res.json()).detail?.message || 'AI í˜¸ì¶œ ì‹¤íŒ¨');
                const result = await res.json();
                const data = result.data;
                
                let html = `<div class="generated-result">
                    <h4>ğŸ’¬ AI ë¶„ì„ ê²°ê³¼</h4>
                    <div class="generated-field">
                        <div class="generated-field-label">ì§ˆë¬¸</div>
                        <div class="generated-field-value">${escapeHtml(data.question)}</div>
                    </div>`;
                
                if (data.interpretation?.selected_api) {
                    const api = data.interpretation.selected_api;
                    html += `
                    <div class="generated-field">
                        <div class="generated-field-label">ì„ íƒëœ API</div>
                        <div class="generated-field-value">${api.method} /api/${api.path}</div>
                    </div>
                    <div class="generated-field">
                        <div class="generated-field-label">ì¶”ì¶œëœ íŒŒë¼ë¯¸í„°</div>
                        <div class="generated-field-value">${formatJson(data.interpretation.params)}</div>
                    </div>
                    <div class="generated-field">
                        <div class="generated-field-label">ì‹ ë¢°ë„</div>
                        <div class="generated-field-value">
                            <span class="badge ${data.interpretation.confidence >= 0.7 ? 'green' : 'red'}">${Math.round(data.interpretation.confidence * 100)}%</span>
                        </div>
                    </div>
                    <div class="generated-field">
                        <div class="generated-field-label">í•´ì„</div>
                        <div class="generated-field-value">${escapeHtml(data.interpretation.explanation)}</div>
                    </div>`;
                    
                    if (data.execution_result) {
                        html += `
                        <div class="generated-field">
                            <div class="generated-field-label">ì‹¤í–‰ ê²°ê³¼</div>
                            <div class="generated-field-value" style="max-height: 300px; overflow: auto;">
                                ${data.execution_result.success 
                                    ? `<span class="badge green">ì„±ê³µ</span><pre style="margin-top:8px">${JSON.stringify(data.execution_result.data, null, 2)}</pre>`
                                    : `<span class="badge red">ì‹¤íŒ¨</span><br>${escapeHtml(data.execution_result.error)}`}
                            </div>
                        </div>`;
                    } else {
                        html += `<button class="submit-btn" style="margin-top: 14px;" onclick="executeFromChat('${api.route_id}', ${JSON.stringify(data.interpretation.params).replace(/"/g, '&quot;')})">â–¶ ì´ API ì‹¤í–‰í•˜ê¸°</button>`;
                    }
                    
                    if (data.interpretation.alternatives?.length) {
                        html += `
                        <div class="generated-field">
                            <div class="generated-field-label">ëŒ€ì•ˆ API</div>
                            <div class="generated-field-value">${data.interpretation.alternatives.map(a => `â€¢ ${a.path}: ${a.reason}`).join('<br>')}</div>
                        </div>`;
                    }
                } else {
                    html += `<div class="alert warning" style="margin-top: 14px;">
                        ì í•©í•œ APIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                        ${escapeHtml(data.interpretation?.explanation || '')}
                    </div>`;
                }
                
                html += '</div>';
                resultDiv.innerHTML = html;
                
            } catch (e) {
                resultDiv.innerHTML = `<div class="alert warning">âŒ ${e.message}</div>`;
            }
        }
        
        async function executeFromChat(routeId, params) {
            const api = apis.find(a => a.id === routeId);
            if (!api) { alert('APIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); return; }
            
            // Select API and fill params
            await selectApi(routeId);
            switchTab('request');
            
            // Fill params
            for (const [key, val] of Object.entries(params)) {
                const input = document.getElementById(`param-${key}`);
                if (input) input.value = val;
            }
            
            // Send request
            setTimeout(() => sendRequest(), 500);
        }
        
        // SQL Optimization
        async function optimizeSqlQuery() {
            const sql = document.getElementById('optimizeSql').value.trim();
            if (!sql) { alert('SQL ì¿¼ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
            if (optimizeSelectedTables.size === 0) { alert('ê´€ë ¨ í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
            
            const resultDiv = document.getElementById('optimizeResult');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            const execTime = document.getElementById('optimizeExecTime').value;
            
            try {
                const res = await fetch('/schema/ai/optimize-sql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sql_query: sql,
                        table_names: Array.from(optimizeSelectedTables),
                        execution_time_ms: execTime ? parseFloat(execTime) : null,
                        model: document.getElementById('optimizeLlmModel').value
                    })
                });
                
                if (!res.ok) throw new Error((await res.json()).detail?.message || 'AI í˜¸ì¶œ ì‹¤íŒ¨');
                const result = await res.json();
                const data = result.data;
                
                let html = `<div class="generated-result">
                    <h4>ğŸ”§ SQL ìµœì í™” ê²°ê³¼</h4>
                    
                    <div class="generated-field">
                        <div class="generated-field-label">ì›ë³¸ ì¿¼ë¦¬</div>
                        <div class="generated-field-value">${escapeHtml(data.original_query)}</div>
                    </div>
                    
                    <div class="generated-field">
                        <div class="generated-field-label">âœ¨ ìµœì í™”ëœ ì¿¼ë¦¬</div>
                        <div class="generated-field-value" style="border: 1px solid var(--accent-green); background: rgba(59, 185, 80, 0.1);">${escapeHtml(data.optimized_query)}</div>
                    </div>
                    
                    ${data.estimated_improvement ? `
                    <div class="generated-field">
                        <div class="generated-field-label">ì˜ˆìƒ ì„±ëŠ¥ í–¥ìƒ</div>
                        <div class="generated-field-value"><span class="badge green">${data.estimated_improvement}</span></div>
                    </div>` : ''}
                    
                    <div class="generated-field">
                        <div class="generated-field-label">ê°œì„  ì œì•ˆ</div>
                        <div class="generated-field-value">
                            ${data.suggestions?.map(s => `
                                <div style="margin-bottom: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 4px; border-left: 3px solid ${s.priority === 'HIGH' ? 'var(--accent-red)' : s.priority === 'MEDIUM' ? 'var(--accent-orange)' : 'var(--accent-blue)'};">
                                    <span class="badge ${s.priority === 'HIGH' ? 'red' : s.priority === 'MEDIUM' ? 'blue' : 'green'}">${s.priority}</span>
                                    <span class="badge purple">${s.type}</span>
                                    <span style="margin-left: 8px;">${escapeHtml(s.message)}</span>
                                </div>
                            `).join('') || 'ì—†ìŒ'}
                        </div>
                    </div>
                    
                    ${data.index_recommendations?.length ? `
                    <div class="generated-field">
                        <div class="generated-field-label">ì¸ë±ìŠ¤ ê¶Œì¥</div>
                        <div class="generated-field-value">
                            ${data.index_recommendations.map(idx => `
                                <div style="margin-bottom: 6px;">
                                    <code>CREATE ${idx.type} INDEX ON ${idx.table}(${idx.columns?.join(', ')})</code>
                                    <br><span style="font-size: 10px; color: var(--text-secondary);">${escapeHtml(idx.reason || '')}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>` : ''}
                    
                    <div class="generated-field">
                        <div class="generated-field-label">ì„¤ëª…</div>
                        <div class="generated-field-value">${escapeHtml(data.explanation)}</div>
                    </div>
                    
                    <button class="submit-btn" style="margin-top: 14px;" onclick="copyToClipboard(\`${escapeHtml(data.optimized_query).replace(/`/g, '\\`')}\`)">ğŸ“‹ ìµœì í™” ì¿¼ë¦¬ ë³µì‚¬</button>
                </div>`;
                
                resultDiv.innerHTML = html;
                
            } catch (e) {
                resultDiv.innerHTML = `<div class="alert warning">âŒ ${e.message}</div>`;
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => alert('âœ… ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤'));
        }
        
        // Test Case Generation
        async function generateTestCases() {
            const apiId = document.getElementById('testcaseApiSelect').value;
            if (!apiId) { alert('APIë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
            
            const resultDiv = document.getElementById('testcaseResult');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const res = await fetch('/schema/ai/generate-test-cases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        route_id: apiId,
                        model: document.getElementById('testcaseLlmModel').value
                    })
                });
                
                if (!res.ok) throw new Error((await res.json()).detail?.message || 'AI í˜¸ì¶œ ì‹¤íŒ¨');
                const result = await res.json();
                const data = result.data;
                
                const typeColors = {
                    positive: 'green',
                    negative: 'red',
                    boundary: 'blue',
                    performance: 'purple'
                };
                
                let html = `<div class="generated-result">
                    <h4>ğŸ§ª ìƒì„±ëœ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ (${data.total_cases}ê°œ)</h4>
                    
                    <div style="margin-bottom: 14px;">
                        <span class="badge green">Positive: ${data.test_cases?.filter(t => t.test_type === 'positive').length || 0}</span>
                        <span class="badge red">Negative: ${data.test_cases?.filter(t => t.test_type === 'negative').length || 0}</span>
                        <span class="badge blue">Boundary: ${data.test_cases?.filter(t => t.test_type === 'boundary').length || 0}</span>
                        <span class="badge purple">Performance: ${data.test_cases?.filter(t => t.test_type === 'performance').length || 0}</span>
                    </div>
                    
                    <div class="audit-list">
                        ${data.test_cases?.map((tc, i) => `
                            <div class="audit-item" style="border-left-color: var(--accent-${typeColors[tc.test_type] || 'blue'});">
                                <div class="audit-header">
                                    <span class="audit-action">${tc.name}</span>
                                    <span class="badge ${typeColors[tc.test_type] || 'blue'}">${tc.test_type}</span>
                                </div>
                                <div class="audit-details" style="margin-top: 8px;">
                                    <strong>ì„¤ëª…:</strong> ${escapeHtml(tc.description)}<br>
                                    <strong>íŒŒë¼ë¯¸í„°:</strong> <code>${JSON.stringify(tc.params)}</code><br>
                                    <strong>ì˜ˆìƒ ë™ì‘:</strong> ${escapeHtml(tc.expected_behavior)}
                                </div>
                                <button class="fill-sample-btn" style="margin-top: 8px;" onclick="runTestCase('${apiId}', ${JSON.stringify(tc.params).replace(/"/g, '&quot;')})">â–¶ ì‹¤í–‰</button>
                            </div>
                        `).join('') || '<div>í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì—†ìŒ</div>'}
                    </div>
                    
                    <button class="submit-btn" style="margin-top: 14px;" onclick="downloadTestCases(${JSON.stringify(data).replace(/"/g, '&quot;')})">ğŸ“¥ JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°</button>
                </div>`;
                
                resultDiv.innerHTML = html;
                
            } catch (e) {
                resultDiv.innerHTML = `<div class="alert warning">âŒ ${e.message}</div>`;
            }
        }
        
        async function runTestCase(apiId, params) {
            await selectApi(apiId);
            switchTab('request');
            
            for (const [key, val] of Object.entries(params)) {
                const input = document.getElementById(`param-${key}`);
                if (input) input.value = typeof val === 'object' ? JSON.stringify(val) : val;
            }
            
            setTimeout(() => sendRequest(), 500);
        }
        
        function downloadTestCases(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-cases-${data.api_path?.replace(/\//g, '-') || 'api'}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Initialize AI features tab when opened
        function initAiFeatures() {
            if (tables.length === 0) loadTables();
            if (llmModels.length === 0) loadLLMModels();
            showAiSubTab('chat');
        }
        
        document.getElementById('searchInput').addEventListener('input', e => renderApiList(e.target.value));
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAddModal(); });
        loadApis();
    </script>
</body>
</html>

